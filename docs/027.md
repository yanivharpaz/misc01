this is my current code which aggregated the data based on staging.locationEvents.
However I guess there are some transformations that already occurred when Ilan
 loads staging.locationEvents that you will also have to do such as hashing advertisingId  using HASH() function
and turning ip addresses to integer using INET_ATON().  
I guess Ilan can give the details of whether he does this while loading to vertica or before hand


INSERT /*+ label({label})*/  INTO {outputTbl}
SELECT max(ts) as ts
, MAX(sessionId)
, MIN(osId)
, MAX(advertisingId)
, sourceIp
, MAX(country)
, MAX(ispId)
, MAX(publisherId)
, productId
, MAX(eDate)
, MAX(cityId)
, MAX(localTs)
, MAX(localTZoneId)
, MAX(locationSourceId)
, longitude
, latitude
, MIN(locationAccuracy)  /* ? */
, MAX(locationTs)
, MAX(ispNameId)
, networkTypeId
, NULLIF(MAX(simMCC),-9999)
, NULLIF(MAX(simMNC),-9999)
, NULLIF(MAX(cellMCC),-9999)
, NULLIF(MAX(cellMNC),-9999)
, MAX(cellLAC)
, MAX(cellId)
, MIN(cellSignalLevel)
, MAX(ssid)
, NULLIF(bssid,-1)
, MIN(signalLevel)
, MAX(ssid1)
, NULLIF(MAX(bssid1),-1)
, MIN(signalLevel1)
, MAX(scanTs1)
, MAX(ssid2)
, NULLIF(MAX(bssid2),-1)
, MIN(signalLevel2)
, MAX(scanTs2)
, MAX(ssid3)
, NULLIF(MAX(bssid3),-1)
, MIN(signalLevel3)
, MAX(scanTs3)
, MAX(ssid4)
, NULLIF(MAX(bssid4),-1)
, MIN(signalLevel4)
, MAX(scanTs4)
, MAX(ssid5)
, NULLIF(MAX(bssid5),-1)
, MIN(signalLevel5)
, MAX(scanTs5)
, MAX(userAgent)
, MAX(sdkTypeId)
, MAX(sourceModuleId)
, MAX(sourceServerId)
, MAX(isCoppaApp)
, MAX(locationContextId)
, MAX(regionId)
, publisherTypeId
, MAX(mRegistered1)
, MAX(cellMcc1)
, MAX(cellMnc1)
, MAX(cellLac1)
, MAX(cellId1)
, MAX(cellUnit1)
, MAX(cellBlon1)
, MAX(cellBlat1)
, MAX(cellRadio1)
, MAX(cellTs1)
, MIN(cellSignalLevel1)
, MAX(mRegistered2)
, MAX(cellMcc2)
, MAX(cellMnc2)
, MAX(cellLac2)
, MAX(cellId2)
, MAX(cellUnit2)
, MAX(cellBlon2)
, MAX(cellBlat2)
, MAX(cellRadio2)
, MAX(cellTs2)
, MIN(cellSignalLevel2)
, MAX(mRegistered3)
, MAX(cellMcc3)
, MAX(cellMnc3)
, MAX(cellLac3)
, MAX(cellId3)
, MAX(cellUnit3)
, MAX(cellBlon3)
, MAX(cellBlat3)
, MAX(cellRadio3)
, MAX(cellTs3)
, MIN(cellSignalLevel3)
, MAX(mRegistered4)
, MAX(cellMcc4)
, MAX(cellMnc4)
, MAX(cellLac4)
, MAX(cellId4)
, MAX(cellUnit4)
, MAX(cellBlon4)
, MAX(cellBlat4)
, MAX(cellRadio4)
, MAX(cellTs4)
, MIN(cellSignalLevel4)
, MAX(mRegistered5)
, MAX(cellMcc5)
, MAX(cellMnc5)
, MAX(cellLac5)
, MAX(cellId5)
, MAX(cellUnit5)
, MAX(cellBlon5)
, MAX(cellBlat5)
, MAX(cellRadio5)
, MAX(cellTs5)
, MIN(cellSignalLevel5)
, MAX(locationSourceId1)
, MAX(longitude1)
, MAX(latitude1)
, MAX(locationAccuracy1)
, MAX(locationTs1)
, MAX(locationSourceId2)
, MAX(longitude2)
, MAX(latitude2)
, MAX(locationAccuracy2)
, MAX(locationTs2)
, MAX(locationSourceId3)
, MAX(longitude3)
, MAX(latitude3)
, MAX(locationAccuracy3)
, MAX(locationTs3)
,MAX(enrichedLatitude)
,MAX(enrichedLongitude)
,MAX(enrichedAccuracy)
,MAX(enrichedLocationTs)
,userId
,MAX(rawIspId)
,MAX(rawIspNameId)
,MAX(eventTypeId)
,MAX(wifiRssiLevel)
,MAX(cellIspNameId)
,MAX(isRoaming)
,MAX(isForeground)
,MAX(wifiRssiLevel1)
,MAX(wifiRssiLevel2)
,MAX(wifiRssiLevel3)
,MAX(wifiRssiLevel4)
,MAX(wifiRssiLevel5)
,MAX(sdkVersionId)
, SYSDATE
, MAX(consumerId)
, MAX(rawClientTS)
, packageId
, MAX(pas)
, MAX(limitAdTracking)
, MAX(isValidAdvertisingId)
, MAX(isValidGps)
, MAX(isValidBssidInt)
, MAX(rtbCarrierNameId)
, MAX(rtbCarrierMcc)
, MAX(rtbCarrierMnc)
,  {runId} as biRunId
, MAX(advertisingIdSourceId)
, MAX(channelId)
, MAX(gdpr)
,MAX(permissions)
,MAX(isLocationEnabled)
,MAX(deviceManufacturerId)
,MAX(deviceModelId)
,MAX(deviceTypeId)
,MAX(deviceVersionId)
,MAX(genderId)
,MAX(age)
,MAX(inputLangsId)
,MAX(geoTypeId)
,MAX(usPrivacyId)
,MAX(localeId)
,MAX(trafficTypeId)
,MAX(sioIdTypeId)
,MAX(siteDomainId)
,MAX(sitePageId)
,MAX(siteNameId)
,SUM(CASE WHEN eventTypeId = 102 THEN 1 ELSE 0 END) as numBidRequests
,count(1) as numEvents
,MAX(appNameId) appNameId
FROM staging.locationEvents
WHERE loadTs > '{loadTsFrom}'
AND loadTs <= '{loadTsTo}'
AND eDate >= '{loadTsFrom}'::DATE -{maxDaysBack}
AND publisherTypeId IN ({publisherTypeIdList})
and isValidAdvertisingId = 1
AND ISNULL(userId,0) NOT IN ( SELECT DISTINCT userId FROM dataOpsStaging.usersToDeleteGDPR WHERE userId is not null)
{countriesClause}
GROUP BY userId
 , time_slice(ts, 1, 'MINUTE')
, sourceIp
, latitude
, longitude
, publisherTypeId
, packageId
, productid
,  bssid
, networkTypeId

;

From: Yaniv Harpaz <yaniv.h.harpaz@oracle.com>
Sent: Sunday, September 7, 2025 7:03 PM
To: Hannah Shachar <hannah.shachar@start.io>; Alex Terehovsky <alex.terehovsky@oracle.com>; Lior Kerzner <lior.kerzner@oracle.com>; Or Ben-David <or.ben.david@oracle.com>; Danna Oudy <danna.oudy@oracle.com>; Ido Bitton <ido.bitton@start.io>; Ilan Huchansky <ilan.huchansky@start.io>; Ilya Kottel <Ilya.Kottel@start.io>; Motti Shpirer <motti@start.io>; Alon Zelovich <alon.zelovich@oracle.com>
Subject: Re: [External] : Re: locationEvents Status
 
Hi Hannah, thanx for the input.
We have a meeting tomorrow at 17:00
 
I’d love to see the code of the current aggregation process, thank you. It would help to focus on the correct solution
 

Yaniv Harpaz | ORACLE CSS
ORACLE Israel | 18 Aharon Bart St. Petach-Tikva
https://linktr.ee/yanivharpaz
 
 
From: Hannah Shachar <hannah.shachar@start.io>
Date: Sunday, 7 September 2025 at 17:43
To: Yaniv Harpaz <yaniv.h.harpaz@oracle.com>, Alex Terehovsky <alex.terehovsky@oracle.com>, Lior Kerzner <lior.kerzner@oracle.com>, Or Ben-David <or.ben.david@oracle.com>, Danna Oudy <danna.oudy@oracle.com>, Ido Bitton <ido.bitton@start.io>, Ilan Huchansky <ilan.huchansky@start.io>, Ilya Kottel <Ilya.Kottel@start.io>, Motti Shpirer <motti@start.io>, Alon Zelovich <alon.zelovich@oracle.com>
Subject: [External] : Re: locationEvents Status

This table is missing many of the columns that are in the target table and some of the existing columns are in the wrong formats/ datatypes
 
I have pasted below the DDL of the production table for comparison. 
 
UserId - has to be Vertica hash, and the result of Vertica hash is a bigint.  it is possible to implement Vertica hash outside of Vertica.  I will get you the details.  Or is it possible to hash it on load, but it might slow down the load. 
 
Most of the columns look incorrect and some look like the data from column x is in column y.  There are also additional columns that do not exist in the original table.
 
Also, do you want to see the code that currently aggregates the data?  So that we can understand the logic?  It is pretty simple. 
 
Maybe we should have a call and go over it all.  
 
The existing table:
 
CREATE TABLE public.locationEvents
(
    ts timestamp,
    sessionId int,
    osId int,
    advertisingId varchar(80),
    sourceIp int,
    country varchar(30),
    ispId int,
    publisherId int,
    productId int,
    eDate date NOT NULL,
    cityId int,
    localTs timestamp,
    localTZoneId int,
    locationSourceId int,
    longitude numeric(13,8),
    latitude numeric(13,8),
    locationAccuracy int,
    locationTs timestamp,
    ispNameId int,
    networkTypeId int,
    simMCC int,
    simMNC int,
    cellMCC int,
    cellMNC int,
    cellLAC int,
    cellId int,
    cellSignalLevel int,
    ssid varchar(32),
    bssid int,
    signalLevel int,
    ssid1 varchar(32),
    bssid1 int,
    signalLevel1 int,
    scanTs1 timestamp,
    ssid2 varchar(32),
    bssid2 int,
    signalLevel2 int,
    scanTs2 timestamp,
    ssid3 varchar(32),
    bssid3 int,
    signalLevel3 int,
    scanTs3 timestamp,
    ssid4 varchar(32),
    bssid4 int,
    signalLevel4 int,
    scanTs4 timestamp,
    ssid5 varchar(32),
    bssid5 int,
    signalLevel5 int,
    scanTs5 timestamp,
    userAgent varchar(1000),
    sdkTypeId int,
    sourceModuleId int,
    sourceServerId int,
    isCoppaApp int,
    locationConte
From: Yaniv Harpaz <yaniv.h.harpaz@oracle.com>
Sent: Wednesday, September 3, 2025 11:00 PM
To: Alex Terehovsky <alex.terehovsky@oracle.com>; Lior Kerzner <lior.kerzner@oracle.com>; Or Ben-David <or.ben.david@oracle.com>; Danna Oudy <danna.oudy@oracle.com>; Ido Bitton <ido.bitton@start.io>; Ilan Huchansky <ilan.huchansky@start.io>; Hannah Shachar <hannah.shachar@start.io>; Ilya Kottel <Ilya.Kottel@start.io>; Motti Shpirer <motti@start.io>; Alon Zelovich <alon.zelovich@oracle.com>
Subject: Re: locationEvents Status
 
Some people who received this message don't often get email from yaniv.h.harpaz@oracle.com. Learn why this is important
Hello everyone,
Here’s an updated status.
 
I’ve got an initial table in Vertica, loaded by the ETL process defines on the requirements doc.
The input was the sample data that Ilan provided us in this storage bucket.
Image
 
sodaoci=> select count(*) from testload.location_events_aggregated;
  count
---------
6700720
(1 row)
 
@Hannah Shachar
can u please take a look at the data inside the table and provide feedback about the logic (based on the requirements doc that was presented at the kickoff).
 
Once we know the logic works well (after feedback and fixing the process accordingly), we can prepare for the load testing.

Yaniv Harpaz | ORACLE CSS
ORACLE Israel | 18 Aharon Bart St. Petach-Tikva
https://linktr.ee/yanivharpaz
 
 
From: Yaniv Harpaz <yaniv.h.harpaz@oracle.com>
Date: Thursday, 21 August 2025 at 15:13
To: Yaniv Harpaz <yaniv.h.harpaz@oracle.com>, Alex Terehovsky <alex.terehovsky@oracle.com>, Lior Kerzner <lior.kerzner@oracle.com>, Or Ben-David <or.ben.david@oracle.com>, Danna Oudy <danna.oudy@oracle.com>, ido.bitton@start.io <ido.bitton@start.io>, Ilan Huchansky <ilan.huchansky@start.io>, Hannah Shachar <hannah.shachar@start.io>, Ilya.Kottel@start.io <Ilya.Kottel@start.io>, motti@start.io <motti@start.io>
Subject: locationEvents Status

Hello,
Here the current status:
The first version of the business logic Apache Spark code that runs on the OCI Data Flow is ready.
Since we still do not a role + user + schema for me to test (Pending Hanna to create)
I used a separate temporary environment where I created locally Vertica + Spark running on local containers in order to develop and have initial test.
Once we have a target Vertica available, we can load the process results into it, so Hanna could check if the results fit the data structure she needs.
Once the functional tests are complete, we can proceed to load testing.
 
@Hannah Shachar
In order not to cause problem at the production environment,
Can we use the new Vertica environment for the functional and load testing?
 
Yaniv
 
 

Yaniv Harpaz | ORACLE CSS
ORACLE Israel | 18 Aharon Bart St. Petach-Tikva
https://linktr.ee/yanivharpaz
 


This table is missing many of the columns that are in the target table and some of the existing columns are in the wrong formats/ datatypes

I have pasted below the DDL of the production table for comparison. 

UserId - has to be Vertica hash, and the result of Vertica hash is a bigint.  it is possible to implement Vertica hash outside of Vertica.  I will get you the details.  Or is it possible to hash it on load, but it might slow down the load. 

Most of the columns look incorrect and some look like the data from column x is in column y.  There are also additional columns that do not exist in the original table.

Also, do you want to see the code that currently aggregates the data?  So that we can understand the logic?  It is pretty simple. 

Maybe we should have a call and go over it all.  

The existing table:

CREATE TABLE public.locationEvents
(
    ts timestamp,
    sessionId int,
    osId int,
    advertisingId varchar(80),
    sourceIp int,
    country varchar(30),
    ispId int,
    publisherId int,
    productId int,
    eDate date NOT NULL,
    cityId int,
    localTs timestamp,
    localTZoneId int,
    locationSourceId int,
    longitude numeric(13,8),
    latitude numeric(13,8),
    locationAccuracy int,
    locationTs timestamp,
    ispNameId int,
    networkTypeId int,
    simMCC int,
    simMNC int,
    cellMCC int,
    cellMNC int,
    cellLAC int,
    cellId int,
    cellSignalLevel int,
    ssid varchar(32),
    bssid int,
    signalLevel int,
    ssid1 varchar(32),
    bssid1 int,
    signalLevel1 int,
    scanTs1 timestamp,
    ssid2 varchar(32),
    bssid2 int,
    signalLevel2 int,
    scanTs2 timestamp,
    ssid3 varchar(32),
    bssid3 int,
    signalLevel3 int,
    scanTs3 timestamp,
    ssid4 varchar(32),
    bssid4 int,
    signalLevel4 int,
    scanTs4 timestamp,
    ssid5 varchar(32),
    bssid5 int,
    signalLevel5 int,
    scanTs5 timestamp,
    userAgent varchar(1000),
    sdkTypeId int,
    sourceModuleId int,
    sourceServerId int,
    isCoppaApp int,
    locationConte
From: Yaniv Harpaz <yaniv.h.harpaz@oracle.com>
Sent: Wednesday, September 3, 2025 11:00 PM
To: Alex Terehovsky <alex.terehovsky@oracle.com>; Lior Kerzner <lior.kerzner@oracle.com>; Or Ben-David <or.ben.david@oracle.com>; Danna Oudy <danna.oudy@oracle.com>; Ido Bitton <ido.bitton@start.io>; Ilan Huchansky <ilan.huchansky@start.io>; Hannah Shachar <hannah.shachar@start.io>; Ilya Kottel <Ilya.Kottel@start.io>; Motti Shpirer <motti@start.io>; Alon Zelovich <alon.zelovich@oracle.com>
Subject: Re: locationEvents Status
 
Some people who received this message don't often get email from yaniv.h.harpaz@oracle.com. Learn why this is important
Hello everyone,
Here’s an updated status.
 
I’ve got an initial table in Vertica, loaded by the ETL process defines on the requirements doc.
The input was the sample data that Ilan provided us in this storage bucket.
Image
 
sodaoci=> select count(*) from testload.location_events_aggregated;
  count
---------
6700720
(1 row)
 
@Hannah Shachar
can u please take a look at the data inside the table and provide feedback about the logic (based on the requirements doc that was presented at the kickoff).
 
Once we know the logic works well (after feedback and fixing the process accordingly), we can prepare for the load testing.

Yaniv Harpaz | ORACLE CSS
ORACLE Israel | 18 Aharon Bart St. Petach-Tikva
https://linktr.ee/yanivharpaz
 
 
From: Yaniv Harpaz <yaniv.h.harpaz@oracle.com>
Date: Thursday, 21 August 2025 at 15:13
To: Yaniv Harpaz <yaniv.h.harpaz@oracle.com>, Alex Terehovsky <alex.terehovsky@oracle.com>, Lior Kerzner <lior.kerzner@oracle.com>, Or Ben-David <or.ben.david@oracle.com>, Danna Oudy <danna.oudy@oracle.com>, ido.bitton@start.io <ido.bitton@start.io>, Ilan Huchansky <ilan.huchansky@start.io>, Hannah Shachar <hannah.shachar@start.io>, Ilya.Kottel@start.io <Ilya.Kottel@start.io>, motti@start.io <motti@start.io>
Subject: locationEvents Status

Hello,
Here the current status:
The first version of the business logic Apache Spark code that runs on the OCI Data Flow is ready.
Since we still do not a role + user + schema for me to test (Pending Hanna to create)
I used a separate temporary environment where I created locally Vertica + Spark running on local containers in order to develop and have initial test.
Once we have a target Vertica available, we can load the process results into it, so Hanna could check if the results fit the data structure she needs.
Once the functional tests are complete, we can proceed to load testing.
 
@Hannah Shachar
In order not to cause problem at the production environment,
Can we use the new Vertica environment for the functional and load testing?
 
Yaniv
 
 

Yaniv Harpaz | ORACLE CSS
ORACLE Israel | 18 Aharon Bart St. Petach-Tikva
https://linktr.ee/yanivharpaz
 
COPY staging.locationEvents(ts, fillsessionId filler VARCHAR(100), sessionId as CASE WHEN fillsessionId IS NOT NULL THEN HASH(fillsessionId) END, sdkTypeId, osId, advertisingId, fillsourceIp filler VARCHAR(100), sourceIp as INET_ATON(fillsourceIp), country, ispId, publisherId, productId, eDate, cityId, localTs, localTZoneId, locationSourceId, longitude, latitude, locationAccuracy, locationTs, ispNameId, networkTypeId, simMCC, simMNC, cellMCC, cellMNC, cellLAC, cellId, cellSignalLevel, ssid, fillbssid filler VARCHAR(100), bssid as macToInt(fillbssid), signalLevel, ssid1, fillbssid1 filler VARCHAR(100), bssid1 as macToInt(fillbssid1), signalLevel1, scanTs1, ssid2, fillbssid2 filler VARCHAR(100), bssid2 as macToInt(fillbssid2), signalLevel2, scanTs2, ssid3, fillbssid3 filler VARCHAR(100), bssid3 as macToInt(fillbssid3), signalLevel3, scanTs3, ssid4, fillbssid4 filler VARCHAR(100), bssid4 as macToInt(fillbssid4), signalLevel4, scanTs4, ssid5, fillbssid5 filler VARCHAR(100), bssid5 as macToInt(fillbssid5), signalLevel5, scanTs5, userAgent, sourceModuleId, sourceServerId, isCoppaApp, locationContextId, regionId, publisherTypeId, mRegistered1, cellMcc1, cellMnc1, cellLac1, cellId1, cellUnit1, cellBlon1, cellBlat1, cellRadio1, cellTs1, cellSignalLevel1, mRegistered2, cellMcc2, cellMnc2, cellLac2, cellId2, cellUnit2, cellBlon2, cellBlat2, cellRadio2, cellTs2, cellSignalLevel2, mRegistered3, cellMcc3, cellMnc3, cellLac3, cellId3, cellUnit3, cellBlon3, cellBlat3, cellRadio3, cellTs3, cellSignalLevel3, mRegistered4, cellMcc4, cellMnc4, cellLac4, cellId4, cellUnit4, cellBlon4, cellBlat4, cellRadio4, cellTs4, cellSignalLevel4, mRegistered5, cellMcc5, cellMnc5, cellLac5, cellId5, cellUnit5, cellBlon5, cellBlat5, cellRadio5, cellTs5, cellSignalLevel5, locationSourceId1, longitude1, latitude1, locationAccuracy1, locationTs1, locationSourceId2, longitude2, latitude2, locationAccuracy2, locationTs2, locationSourceId3, longitude3, latitude3, locationAccuracy3, locationTs3, enrichedLatitude, enrichedLongitude, enrichedAccuracy, enrichedLocationTs, filluserId filler VARCHAR(100), userId as CASE WHEN filluserId IS NOT NULL THEN HASH(filluserId) END, rawIspId, rawIspNameId, eventTypeId, wifiRssiLevel, cellIspNameId, isRoaming, isForeground, wifiRssiLevel1, wifiRssiLevel2, wifiRssiLevel3, wifiRssiLevel4, wifiRssiLevel5, sdkVersionId, fillloadTs filler TIMESTAMP, loadTs as date_trunc('second', sysdate), consumerId, rawClientTS, packageId, limitAdTracking, isValidAdvertisingId, isValidGps, isValidBssidInt, rtbCarrierNameId, rtbCarrierMcc, rtbCarrierMnc, pas, permissions, isLocationEnabled, deviceVersionId, releaseVersionId, advertisingIdSourceId, deviceModelId, deviceManufacturerId, localeId, inputLangsId) FROM '/nfs/etl/sdkLocation/in-progress/20250908115550/*' ON ANY NODE GZIP DELIMITER E' ' ESCAPE as E'' REJECTED DATA AS TABLE staging.locationEventsRejectedData TRAILING NULLCOLS DIRECT;


macToInt
RETURN CASE WHEN regexp_like(bssid, E'^(?:[[:xdigit:]]{2}([-:]))(?:[[:xdigit:]]{2}\\1){4}[[:xdigit:]]{2}$', '') THEN ((regexp_replace(regexp_replace(bssid, '[-:]', '', 1, 0, ''), E'^\\s*([-+]?)(?:0[xX])?', E'\\g{1}0x', 1, 0, ''))::numeric)::int ELSE (-1) END


def inet_aton(col):
    parts = F.split(col, r'\.')
    p0 = parts.getItem(0).cast('bigint')
    p1 = parts.getItem(1).cast('bigint')
    p2 = parts.getItem(2).cast('bigint')
    p3 = parts.getItem(3).cast('bigint')

    # basic validation: 4 parts and each 0–255
    valid = (
        (F.size(parts) == 4) &
        (p0.between(0,255)) & (p1.between(0,255)) &
        (p2.between(0,255)) & (p3.between(0,255))
    )

    value = (p0 * (256**3) + p1 * (256**2) + p2 * 256 + p3)
    return F.when(valid, value).otherwise(F.lit(None).cast('bigint'))


Vertica Hash:  I will get you the logic

Hannah
054-227-9515



